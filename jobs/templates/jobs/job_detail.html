{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}{{ job.title }} | Job Details{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-sm border border-gray-200">
  
  <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ job.title }}</h1>
  
  <p class="text-gray-600 mb-4">{{ job.company.name }}</p>

  <div class="space-y-2 mb-6 text-gray-700">
    <p><span class="font-semibold">Location:</span> {{ job.location|default:"Not specified" }}</p>
    <p><span class="font-semibold">Salary:</span>
      {% if job.salary %}
        ₹{{ job.salary }}
      {% else %}
        Not disclosed
      {% endif %}
    </p>
    <p><span class="font-semibold">Posted on:</span> {{ job.posted_date|date:"F j, Y" }}</p>
  </div>

  <div class="border-t border-gray-200 pt-4">
    <h2 class="text-lg font-semibold text-gray-900 mb-2">Job Description</h2>
    <p class="text-gray-700 leading-relaxed whitespace-pre-line">
      {{ job.description|default:"No description provided." }}
    </p>
  </div>

  <div class="mt-8 flex justify-between items-center">
    {% if back_from == "myPosts" %}
      <a href="{% url 'jobs:myPosts' %}" class="text-blue-600 hover:underline">← Back to My Posts</a>
    {% elif back_from == "dashboard" %}
      <a href="{% url 'dashboard:dashboard' %}" class="text-blue-600 hover:underline">← Back to Dashboard</a>
    {% elif back_from == "jobSearch" %}
      <a href="{% url 'jobs:jobSearch' %}" class="text-blue-600 hover:underline">← Back to Search</a>
    {% else %}
      <a href="{% url 'jobs:jobList' %}" class="text-blue-600 hover:underline">← Back to Job Listings</a>
    {% endif %}
  
    {% if user.is_authenticated and not user.is_staff and not user.is_superuser %}
      <a href="{% url 'jobs:applyJob' job.pk %}" class="bg-blue-600 text-white font-medium px-5 py-2 rounded-md hover:bg-blue-700 transition">
        Apply Now
      </a>
    {% endif %}
  </div>

</div>
<div class="border-t border-gray-200 pt-6 mt-8">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">Company Reviews ({{ review_count }})</h2>

  <!-- Average Rating -->
  <p class="text-gray-700 mb-4">
    <strong>Average Rating:</strong>
    {% if average_rating %}
      {{ average_rating|floatformat:1 }} ★
    {% else %}
      No ratings yet
    {% endif %}
  </p>

  <!-- Review Form -->
  {% if user.is_authenticated %}
    <div class="bg-gray-50 p-4 rounded-lg border mb-6">
      <h3 class="text-lg font-semibold mb-3">
        {% if user_review %}Update Your Review{% else %}Write a Review{% endif %}
      </h3>
    
      <form method="post" class="space-y-4" id="reviewForm">
        {% csrf_token %}
        {{ form.rating }}
        
        <!-- Star Rating UI -->
        <div class="flex items-center space-x-2" id="starRating">
          {% for i in "12345" %}
            <button type="button" class="text-gray-400 text-2xl focus:outline-none" data-value="{{ forloop.counter }}">★</button>
          {% endfor %}
        </div>
    
        <div>
            {{ form.comment|add_class:"w-full p-2 border rounded-lg resize-y" }}
        </div>
    
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
          {% if user_review %}Update{% else %}Submit{% endif %}
        </button>
      </form>
    </div>
    
  {% else %}
    <p class="text-gray-600 mb-4">Please <a href="{% url 'login' %}" class="text-blue-600 hover:underline">log in</a> to post a review.</p>
  {% endif %}

  <!-- All Reviews -->
  <div class="space-y-4">
    {% for review in reviews %}
      <div class="border rounded-lg p-4 bg-white shadow-sm">
        <div class="flex justify-between items-center mb-1">
          <span class="font-semibold text-gray-800">{{ review.user.username }}</span>
          <span class="text-yellow-500">{{ review.rating }} ★</span>
        </div>
        <p class="text-gray-700">{{ review.comment|default:"(No comment)" }}</p>
        <p class="text-sm text-gray-500 mt-1">{{ review.created_at|date:"F j, Y" }}</p>
      </div>
    {% empty %}
      <p class="text-gray-600">No reviews yet. Be the first to review {{ company.name }}!</p>
    {% endfor %}
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const stars = document.querySelectorAll("#starRating button");
  const hiddenInput = document.querySelector("input[name='rating']");
  if (!hiddenInput) return;
  let currentRating = parseInt(hiddenInput.value || 0);

  const setStars = (rating) => {
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add("text-yellow-400");
        star.classList.remove("text-gray-400");
      } else {
        star.classList.add("text-gray-400");
        star.classList.remove("text-yellow-400");
      }
    });
  };

  stars.forEach((star, index) => {
    star.addEventListener("click", () => {
      currentRating = index + 1;
      hiddenInput.value = currentRating;
      setStars(currentRating);
    });
  });

  // Set initial stars if editing an existing review
  if (currentRating > 0) setStars(currentRating);
});
</script>

{% endblock %}